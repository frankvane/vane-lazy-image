{
    "sourceFile": "src/pages/WorkerFixTest.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1759223809566,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1759223809566,
            "name": "Commit-0",
            "content": "/**\r\n * Worker ä¿®å¤æµ‹è¯•é¡µé¢\r\n * éªŒè¯ createImageBitmap æ›¿ä»£ Image æ„é€ å‡½æ•°çš„ä¿®å¤\r\n */\r\n\r\nimport React, { useEffect, useState } from \"react\";\r\nimport {\r\n  detectWorkerCapabilities,\r\n  getWorkerRecommendation,\r\n  testWorkerFunctionality,\r\n} from \"../components/LazyImage/utils/workerDetection\";\r\n\r\nimport { LazyImage } from \"../components/LazyImage\";\r\n\r\nconst WorkerFixTest: React.FC = () => {\r\n  const [workerStatus, setWorkerStatus] = useState<any>(null);\r\n  const [testResults, setTestResults] = useState<any>(null);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [testImages, setTestImages] = useState<any[]>([]);\r\n\r\n  useEffect(() => {\r\n    // æ£€æµ‹ Worker èƒ½åŠ›\r\n    const capabilities = detectWorkerCapabilities();\r\n    const recommendation = getWorkerRecommendation();\r\n\r\n    setWorkerStatus({\r\n      capabilities,\r\n      recommendation,\r\n    });\r\n\r\n    // ç”Ÿæˆæµ‹è¯•å›¾ç‰‡\r\n    const images = Array.from({ length: 6 }, (_, i) => ({\r\n      id: i,\r\n      src: `https://picsum.photos/400/300?random=${i + 5000}`,\r\n      alt: `Worker æµ‹è¯•å›¾ç‰‡ ${i + 1}`,\r\n    }));\r\n    setTestImages(images);\r\n  }, []);\r\n\r\n  const handleTestWorker = async () => {\r\n    setIsLoading(true);\r\n    try {\r\n      const isWorking = await testWorkerFunctionality();\r\n      setTestResults({\r\n        isWorking,\r\n        timestamp: new Date().toISOString(),\r\n        message: isWorking ? \"Worker åŠŸèƒ½æ­£å¸¸\" : \"Worker åŠŸèƒ½å¼‚å¸¸\",\r\n      });\r\n    } catch (error) {\r\n      setTestResults({\r\n        isWorking: false,\r\n        error: error instanceof Error ? error.message : \"æœªçŸ¥é”™è¯¯\",\r\n        timestamp: new Date().toISOString(),\r\n        message: \"Worker æµ‹è¯•å¤±è´¥\",\r\n      });\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div style={{ padding: \"20px\", maxWidth: \"1200px\", margin: \"0 auto\" }}>\r\n      <h1>ğŸ”§ Worker ä¿®å¤æµ‹è¯•</h1>\r\n\r\n      <div style={{ marginBottom: \"30px\" }}>\r\n        <h2>é—®é¢˜ä¿®å¤è¯´æ˜</h2>\r\n        <div style={{ backgroundColor: \"#d4edda\", padding: \"15px\", borderRadius: \"8px\", marginBottom: \"20px\" }}>\r\n          <h4>âœ… å·²ä¿®å¤çš„é—®é¢˜ï¼š</h4>\r\n          <p><strong>é”™è¯¯ï¼š</strong> <code>ReferenceError: Image is not defined</code></p>\r\n          <p><strong>åŸå› ï¼š</strong> Web Worker ç¯å¢ƒä¸­æ²¡æœ‰ DOM APIï¼ŒåŒ…æ‹¬ <code>Image</code> æ„é€ å‡½æ•°</p>\r\n          <p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong> ä½¿ç”¨ <code>createImageBitmap()</code> æ›¿ä»£ <code>new Image()</code></p>\r\n        </div>\r\n\r\n        <div style={{ backgroundColor: \"#f8f9fa\", padding: \"15px\", borderRadius: \"8px\" }}>\r\n          <h4>ğŸ”§ ä¿®å¤è¯¦æƒ…ï¼š</h4>\r\n          <pre style={{ fontSize: \"12px\", overflow: \"auto\" }}>\r\n{`// âŒ ä¿®å¤å‰ (åœ¨ Worker ä¸­ä¼šæŠ¥é”™)\r\nconst img = new Image();\r\nimg.onload = function() {\r\n  // å¤„ç†å›¾ç‰‡\r\n};\r\nimg.src = imageUrl;\r\n\r\n// âœ… ä¿®å¤å (Worker å…¼å®¹)\r\nconst imageBitmap = await createImageBitmap(blob);\r\n// ç›´æ¥ä½¿ç”¨ imageBitmap è¿›è¡Œç»˜åˆ¶\r\nctx.drawImage(imageBitmap, x, y, width, height);\r\nimageBitmap.close(); // æ¸…ç†èµ„æº`}\r\n          </pre>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Worker çŠ¶æ€æ£€æµ‹ */}\r\n      <div style={{ marginBottom: \"30px\" }}>\r\n        <h2>Worker èƒ½åŠ›æ£€æµ‹</h2>\r\n        {workerStatus && (\r\n          <div style={{ display: \"grid\", gridTemplateColumns: \"1fr 1fr\", gap: \"20px\" }}>\r\n            <div>\r\n              <h3>æµè§ˆå™¨æ”¯æŒæƒ…å†µ</h3>\r\n              <ul>\r\n                <li>Web Workers: {workerStatus.capabilities.hasWorker ? \"âœ…\" : \"âŒ\"}</li>\r\n                <li>OffscreenCanvas: {workerStatus.capabilities.hasOffscreenCanvas ? \"âœ…\" : \"âŒ\"}</li>\r\n                <li>CreateImageBitmap: {workerStatus.capabilities.hasCreateImageBitmap ? \"âœ…\" : \"âŒ\"}</li>\r\n                <li>Fetch API: {workerStatus.capabilities.hasFetch ? \"âœ…\" : \"âŒ\"}</li>\r\n                <li>Transferable Objects: {workerStatus.capabilities.hasTransferableObjects ? \"âœ…\" : \"âŒ\"}</li>\r\n                <li>æ€§èƒ½ç­‰çº§: {workerStatus.capabilities.estimatedPerformance}</li>\r\n              </ul>\r\n            </div>\r\n            <div>\r\n              <h3>æ¨èé…ç½®</h3>\r\n              <ul>\r\n                <li>ä½¿ç”¨ Worker: {workerStatus.recommendation.shouldUseWorker ? \"âœ…\" : \"âŒ\"}</li>\r\n                <li>æœ€å¤§ Worker æ•°: {workerStatus.recommendation.maxWorkers}</li>\r\n                <li>å¯ç”¨é™çº§: {workerStatus.recommendation.enableFallback ? \"âœ…\" : \"âŒ\"}</li>\r\n                <li>åŸå› : {workerStatus.recommendation.reason}</li>\r\n              </ul>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* åŠŸèƒ½æµ‹è¯• */}\r\n      <div style={{ marginBottom: \"30px\" }}>\r\n        <h2>åŠŸèƒ½æµ‹è¯•</h2>\r\n        <button\r\n          onClick={handleTestWorker}\r\n          disabled={isLoading}\r\n          style={{\r\n            padding: \"10px 20px\",\r\n            backgroundColor: isLoading ? \"#ccc\" : \"#007bff\",\r\n            color: \"white\",\r\n            border: \"none\",\r\n            borderRadius: \"4px\",\r\n            cursor: isLoading ? \"not-allowed\" : \"pointer\",\r\n            marginBottom: \"20px\",\r\n          }}\r\n        >\r\n          {isLoading ? \"æµ‹è¯•ä¸­...\" : \"æµ‹è¯• Worker åŠŸèƒ½\"}\r\n        </button>\r\n\r\n        {testResults && (\r\n          <div style={{\r\n            padding: \"15px\",\r\n            backgroundColor: testResults.isWorking ? \"#d4edda\" : \"#f8d7da\",\r\n            borderRadius: \"4px\",\r\n            border: `1px solid ${testResults.isWorking ? \"#c3e6cb\" : \"#f5c6cb\"}`,\r\n          }}>\r\n            <h4>æµ‹è¯•ç»“æœ</h4>\r\n            <p><strong>çŠ¶æ€:</strong> {testResults.message}</p>\r\n            <p><strong>æ—¶é—´:</strong> {testResults.timestamp}</p>\r\n            {testResults.error && <p style={{ color: \"#721c24\" }}><strong>é”™è¯¯:</strong> {testResults.error}</p>}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* å®é™…å›¾ç‰‡æµ‹è¯• */}\r\n      <div style={{ marginBottom: \"30px\" }}>\r\n        <h2>å®é™…å›¾ç‰‡æµ‹è¯•</h2>\r\n        <p>æµ‹è¯•ä¿®å¤åçš„ LQIP Worker åŠŸèƒ½ï¼š</p>\r\n\r\n        <div style={{ display: \"grid\", gridTemplateColumns: \"repeat(auto-fit, minmax(200px, 1fr))\", gap: \"15px\" }}>\r\n          {testImages.map((image, index) => (\r\n            <div key={image.id} style={{\r\n              backgroundColor: \"white\",\r\n              borderRadius: \"8px\",\r\n              overflow: \"hidden\",\r\n              boxShadow: \"0 2px 8px rgba(0,0,0,0.1)\",\r\n              padding: \"10px\",\r\n            }}>\r\n              <h4 style={{ margin: \"0 0 10px 0\", fontSize: \"14px\" }}>å›¾ç‰‡ {index + 1}</h4>\r\n              <LazyImage\r\n                src={image.src}\r\n                alt={image.alt}\r\n                style={{ width: \"100%\", height: \"150px\", objectFit: \"cover\" }}\r\n                enableLQIP={true}\r\n                lqipWidth={20}\r\n                lqipQuality={0.6}\r\n                enableLQIPWorker={true}\r\n                showLoadingIndicator={true}\r\n                priority={index < 2 ? \"high\" : \"medium\"}\r\n                onLoad={() => {\r\n                  console.log(`âœ… å›¾ç‰‡ ${index + 1} åŠ è½½æˆåŠŸ (Worker ä¿®å¤éªŒè¯)`);\r\n                }}\r\n                onError={(error) => {\r\n                  console.error(`âŒ å›¾ç‰‡ ${index + 1} åŠ è½½å¤±è´¥:`, error);\r\n                }}\r\n              />\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n\r\n      {/* å¯¹æ¯”æµ‹è¯• */}\r\n      <div style={{ marginBottom: \"30px\" }}>\r\n        <h2>å¯¹æ¯”æµ‹è¯•</h2>\r\n        <p>å¯¹æ¯”å¯ç”¨å’Œç¦ç”¨ Worker çš„æ•ˆæœï¼š</p>\r\n\r\n        <div style={{ display: \"grid\", gridTemplateColumns: \"1fr 1fr\", gap: \"20px\" }}>\r\n          <div>\r\n            <h4>âœ… å¯ç”¨ Worker (ä¿®å¤å)</h4>\r\n            <LazyImage\r\n              src=\"https://picsum.photos/600/400?random=9999\"\r\n              alt=\"Worker æµ‹è¯• - å¯ç”¨\"\r\n              style={{ width: \"100%\", height: \"200px\", objectFit: \"cover\" }}\r\n              enableLQIP={true}\r\n              lqipWidth={24}\r\n              lqipQuality={0.7}\r\n              enableLQIPWorker={true}\r\n              showLoadingIndicator={true}\r\n              priority=\"high\"\r\n            />\r\n          </div>\r\n\r\n          <div>\r\n            <h4>ğŸ”„ ç¦ç”¨ Worker (ä¸»çº¿ç¨‹)</h4>\r\n            <LazyImage\r\n              src=\"https://picsum.photos/600/400?random=9999\"\r\n              alt=\"Worker æµ‹è¯• - ç¦ç”¨\"\r\n              style={{ width: \"100%\", height: \"200px\", objectFit: \"cover\" }}\r\n              enableLQIP={true}\r\n              lqipWidth={24}\r\n              lqipQuality={0.7}\r\n              enableLQIPWorker={false}\r\n              showLoadingIndicator={true}\r\n              priority=\"high\"\r\n            />\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* æŠ€æœ¯è¯´æ˜ */}\r\n      <div style={{ marginBottom: \"30px\" }}>\r\n        <h2>æŠ€æœ¯è¯´æ˜</h2>\r\n        <div style={{ backgroundColor: \"#f8f9fa\", padding: \"20px\", borderRadius: \"8px\" }}>\r\n          <h4>createImageBitmap vs Image æ„é€ å‡½æ•°ï¼š</h4>\r\n          <ul>\r\n            <li><strong>createImageBitmap</strong> - Web Worker å…¼å®¹ï¼Œå¼‚æ­¥å¤„ç†ï¼Œæ€§èƒ½æ›´å¥½</li>\r\n            <li><strong>Image æ„é€ å‡½æ•°</strong> - ä»…ä¸»çº¿ç¨‹å¯ç”¨ï¼ŒåŒæ­¥åŠ è½½ï¼ŒDOM ä¾èµ–</li>\r\n          </ul>\r\n\r\n          <h4>ä¿®å¤ä¼˜åŠ¿ï¼š</h4>\r\n          <ul>\r\n            <li>âœ… å®Œå…¨å…¼å®¹ Web Worker ç¯å¢ƒ</li>\r\n            <li>âœ… æ›´å¥½çš„å†…å­˜ç®¡ç† (imageBitmap.close())</li>\r\n            <li>âœ… å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡ Worker çº¿ç¨‹</li>\r\n            <li>âœ… æ”¯æŒæ›´å¤šå›¾ç‰‡æ ¼å¼</li>\r\n            <li>âœ… æ›´å¥½çš„é”™è¯¯å¤„ç†</li>\r\n          </ul>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default WorkerFixTest;\r\n"
        }
    ]
}